<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Finch&#39;s Blog</title>
  
  
  <link href="https://adooobe.github.io/atom.xml" rel="self"/>
  
  <link href="https://adooobe.github.io/"/>
  <updated>2024-04-10T00:37:08.971Z</updated>
  <id>https://adooobe.github.io/</id>
  
  <author>
    <name>Finch Xia</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>data-lineage</title>
    <link href="https://adooobe.github.io/2024/04/10/data-lineage/"/>
    <id>https://adooobe.github.io/2024/04/10/data-lineage/</id>
    <published>2024-04-10T00:37:08.000Z</published>
    <updated>2024-04-10T00:37:08.971Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>sql-parser design</title>
    <link href="https://adooobe.github.io/2024/04/09/sql-parser/"/>
    <id>https://adooobe.github.io/2024/04/09/sql-parser/</id>
    <published>2024-04-09T05:50:47.000Z</published>
    <updated>2024-04-10T06:03:44.581Z</updated>
    
    <content type="html"><![CDATA[<h2 id="TDOP-Top-Down-Operator-Precedence-Algorithm"><a href="#TDOP-Top-Down-Operator-Precedence-Algorithm" class="headerlink" title="TDOP(Top Down Operator Precedence) Algorithm"></a>TDOP(Top Down Operator Precedence) Algorithm</h2><p>The Top-Down Operator Precedence (TDOP) algorithm primarily addresses the challenge of efficiently performing lexical and syntactic analysis in compilers, especially in handling operator precedence and associativity rules. By setting different precedence levels and utilizing a look-ahead mechanism, TDOP effectively manages issues related to operator left-associativity, right-associativity, and parentheses, thereby enabling a concise and flexible strategy for parsing expressions. This approach simplifies and streamlines the process of parsing various expression syntaxes, making it widely applicable in the design of compilers and interpreters.</p><blockquote><p>Top down operator precedence parsing (TDOP from now on) is based on a few fundamental principles:</p><ul><li>A “binding power” mechanism to handle precedence levels</li><li>A means of implementing different functionality of tokens depending on their position relative to their neighbors - prefix or infix.</li><li>As opposed to classic RD, where semantic actions are associated with grammar rules (BNF), TDOP associates them with tokens.</li></ul></blockquote><h3 id="Bind-Power"><a href="#Bind-Power" class="headerlink" title="Bind Power"></a>Bind Power</h3><p>In my opinion, bind power is used to define the operator precedence. There are two bind powers (lbp and rbp) for each token in TDOP Algorithm to determine the order precedence. Sepecilly, for the ternary operator like <code>a = b ? c : d</code>, it can be devided into two binary operator <code>?</code> and <code>:</code>.</p><p>For example, there is an expression including two different tokens and three expressions(although it is only one letter)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a + b * c</span><br><span class="line">^ ^ ^ ^ ^</span><br><span class="line">E A F B G</span><br></pre></td></tr></table></figure><p>We know that multiplication take precedence of addition operator, so we can set the bind power of multiplication = 20, addtion = 10 for the process of TDOP Algorithm to transfer the expressions to AST(Abstract Syntax Tree).</p><h3 id="Pseudocode"><a href="#Pseudocode" class="headerlink" title="Pseudocode"></a>Pseudocode</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">expression</span>(<span class="params">rbp=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">global</span> token</span><br><span class="line">    t = token</span><br><span class="line">    token = <span class="built_in">next</span>()</span><br><span class="line">    left = t.nud()</span><br><span class="line">    <span class="keyword">while</span> rbp &lt; token.lbp:</span><br><span class="line">        t = token</span><br><span class="line">        token = <span class="built_in">next</span>()</span><br><span class="line">        left = t.led(left)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> left</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">literal_token</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value</span>):</span><br><span class="line">        self.value = <span class="built_in">int</span>(value)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">nud</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.value</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">operator_add_token</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    lbp = <span class="number">10</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">led</span>(<span class="params">self, left</span>):</span><br><span class="line">        right = expression(<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">return</span> left + right</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">operator_mul_token</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    lbp = <span class="number">20</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">led</span>(<span class="params">self, left</span>):</span><br><span class="line">        <span class="keyword">return</span> left * expression(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">end_token</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    lbp = <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Besides, in our instance, a simple tokenizer for basic arithmetic operations is neccessary</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">token_pat = re.<span class="built_in">compile</span>(<span class="string">&quot;\s*(?:(\d+)|(.))&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tokenize</span>(<span class="params">program</span>):</span><br><span class="line">    <span class="keyword">for</span> number, operator <span class="keyword">in</span> token_pat.findall(program):</span><br><span class="line">        <span class="keyword">if</span> number:</span><br><span class="line">            <span class="keyword">yield</span> literal_token(number)</span><br><span class="line">        <span class="keyword">elif</span> operator == <span class="string">&quot;+&quot;</span>:</span><br><span class="line">            <span class="keyword">yield</span> operator_add_token()</span><br><span class="line">        <span class="keyword">elif</span> operator == <span class="string">&quot;*&quot;</span>:</span><br><span class="line">            <span class="keyword">yield</span> operator_mul_token()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> SyntaxError(<span class="string">&#x27;unknown operator: %s&#x27;</span>, operator)</span><br><span class="line">    <span class="keyword">yield</span> end_token()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">program</span>):</span><br><span class="line">    <span class="keyword">global</span> token, <span class="built_in">next</span></span><br><span class="line">    <span class="built_in">next</span> = tokenize(program).<span class="built_in">next</span></span><br><span class="line">    token = <span class="built_in">next</span>()</span><br><span class="line">    <span class="keyword">return</span> expression()</span><br></pre></td></tr></table></figure><p>We should notice that function <code>def tokenize(program)</code> using <code>yield</code>, which return a generator it can be seen as an iterator to use.</p><p>Let’s see an example:</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span> + <span class="number">1</span> * <span class="number">2</span> * <span class="number">4</span> + <span class="number">5</span></span><br></pre></td></tr></table></figure><p>process:</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;expression with rbp <span class="number">0</span>&gt;&gt; </span><br><span class="line">    &lt;&lt;literal nud = <span class="number">3</span>&gt;&gt;</span><br><span class="line">    &lt;&lt;led of <span class="string">&quot;+&quot;</span>&gt;&gt;</span><br><span class="line">    &lt;&lt;expression with rbp <span class="number">10</span>&gt;&gt; call <span class="string">&#x27;+&#x27;</span>.led(<span class="number">3</span>)</span><br><span class="line">       &lt;&lt;literal nud = <span class="number">1</span>&gt;&gt;</span><br><span class="line">       &lt;&lt;led of <span class="string">&quot;*&quot;</span>&gt;&gt;</span><br><span class="line">       &lt;&lt;expression with rbp <span class="number">20</span>&gt;&gt; call <span class="string">&#x27;*&#x27;</span>.led(<span class="number">1</span>)</span><br><span class="line">          &lt;&lt;literal nud = <span class="number">2</span>&gt;&gt; <span class="keyword">return</span> <span class="number">1</span> * <span class="number">2</span></span><br><span class="line">       &lt;&lt;led of <span class="string">&quot;*&quot;</span>&gt;&gt;</span><br><span class="line">       &lt;&lt;expression with rbp <span class="number">20</span>&gt;&gt; call <span class="string">&#x27;*&#x27;</span>.led(<span class="number">2</span>)</span><br><span class="line">          &lt;&lt;literal nud = <span class="number">4</span>&gt;&gt; <span class="keyword">return</span> <span class="number">2</span> * <span class="number">4</span></span><br><span class="line">    &lt;&lt;led of <span class="string">&quot;+&quot;</span>&gt;&gt;</span><br><span class="line">    &lt;&lt;expression with rbp <span class="number">10</span>&gt;&gt; call <span class="string">&#x27;+&#x27;</span>.led(<span class="number">8</span>)</span><br><span class="line">       &lt;&lt;literal nud = <span class="number">5</span>&gt;&gt; <span class="keyword">return</span> <span class="number">8</span> + <span class="number">5</span></span><br></pre></td></tr></table></figure><h4 id="Duality"><a href="#Duality" class="headerlink" title="Duality"></a>Duality</h4><p>Ok, let us think about subtraction operator. Generally, on both sides of a subtraction operation, there is an expression, but sometimes the subtraction can also be considered as a negation operation. In other words, for <code>&#39;-&#39;</code>, it could be both binary andunary operator.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">operator_sub_token</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    lbp = <span class="number">10</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">nud</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> -expression(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">led</span>(<span class="params">self, left</span>):</span><br><span class="line">        <span class="keyword">return</span> left - expression(<span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>Example:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3 - 2 + 4 * -5</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;&lt;expression <span class="keyword">with</span> rbp <span class="number">0</span>&gt;&gt; </span><br><span class="line">    &lt;&lt;literal nud = <span class="number">3</span>&gt;&gt;</span><br><span class="line">    &lt;&lt;led of <span class="string">&quot;-&quot;</span>&gt;&gt;</span><br><span class="line">    &lt;&lt;expression <span class="keyword">with</span> rbp <span class="number">10</span>&gt;&gt; call <span class="string">&#x27;-&#x27;</span>.led(<span class="number">3</span>)</span><br><span class="line">       &lt;&lt;literal nud = <span class="number">2</span>&gt;&gt;</span><br><span class="line">       &lt;&lt;lbp = rbp = <span class="number">10</span>&gt;&gt; <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">    &lt;&lt;led of <span class="string">&quot;+&quot;</span>&gt;&gt; </span><br><span class="line">       &lt;&lt;expression <span class="keyword">with</span> rbp <span class="number">10</span>&gt;&gt; call <span class="string">&#x27;+&#x27;</span>.led(<span class="number">1</span>)</span><br><span class="line">          &lt;&lt;literal nud = <span class="number">4</span>&gt;&gt;</span><br><span class="line">          &lt;&lt;led of <span class="string">&quot;*&quot;</span>&gt;&gt; call <span class="string">&#x27;*&#x27;</span>.led(<span class="number">4</span>)</span><br><span class="line">            &lt;&lt;expression <span class="keyword">with</span> rbp <span class="number">20</span>&gt;&gt; call -expression(<span class="number">100</span>)</span><br><span class="line">              &lt;&lt;nud of <span class="string">&quot;-&quot;</span>&gt;&gt; </span><br><span class="line">                &lt;&lt;expression <span class="keyword">with</span> rbp <span class="number">100</span>&gt;&gt;</span><br><span class="line">                  &lt;&lt;literal nud = <span class="number">5</span>&gt;&gt; <span class="keyword">return</span> <span class="number">5</span></span><br><span class="line">                <span class="comment"># return -5</span></span><br><span class="line">            <span class="comment"># return 4 * -5</span></span><br><span class="line">       <span class="comment"># return left = 1 + -20</span></span><br><span class="line">    <span class="comment"># return -19</span></span><br></pre></td></tr></table></figure><h4 id="Right-Associative"><a href="#Right-Associative" class="headerlink" title="Right Associative"></a>Right Associative</h4><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li><a href="https://eli.thegreenplace.net/2010/01/02/top-down-operator-precedence-parsing">https://eli.thegreenplace.net/2010/01/02/top-down-operator-precedence-parsing</a><br>2.</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;TDOP-Top-Down-Operator-Precedence-Algorithm&quot;&gt;&lt;a href=&quot;#TDOP-Top-Down-Operator-Precedence-Algorithm&quot; class=&quot;headerlink&quot; title=&quot;TDOP(T</summary>
      
    
    
    
    
    <category term="sqlparser, TDOP" scheme="https://adooobe.github.io/tags/sqlparser-TDOP/"/>
    
  </entry>
  
  <entry>
    <title>mysql-cdc</title>
    <link href="https://adooobe.github.io/2023/12/21/mysql-cdc/"/>
    <id>https://adooobe.github.io/2023/12/21/mysql-cdc/</id>
    <published>2023-12-21T07:38:37.000Z</published>
    <updated>2024-04-08T01:39:35.288Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CDC-Process"><a href="#CDC-Process" class="headerlink" title="CDC Process"></a>CDC Process</h2><p>A common binlog stream reader contains the parts as follows. However, in many open source library or project, some important steps are boxed as internal processes. Frequently, user should only concern about the connection to the server and how to handle the BinlogEvents. I will use <a href="https://github.com/rusuly/mysql_cdc">rust-mysql-cdc</a> to introduce the whole process of mysql cdc.</p><h3 id="Connect-to-MySQL-Server-amp-Authentication"><a href="#Connect-to-MySQL-Server-amp-Authentication" class="headerlink" title="Connect to MySQL Server &amp; Authentication"></a>Connect to MySQL Server &amp; Authentication</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">connect</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(PacketChannel, DatabaseProvider), Error&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = PacketChannel::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">self</span>.options)?;</span><br><span class="line">        <span class="keyword">let</span> (packet, seq_num) = channel.<span class="title function_ invoke__">read_packet</span>()?;</span><br><span class="line">        <span class="title function_ invoke__">check_error_packet</span>(&amp;packet, <span class="string">&quot;Initial handshake error.&quot;</span>)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handshake</span> = HandshakePacket::<span class="title function_ invoke__">parse</span>(&amp;packet)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">auth_plugin</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">get_auth_plugin</span>(&amp;handshake.auth_plugin_name)?;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">authenticate</span>(&amp;<span class="keyword">mut</span> channel, &amp;handshake, auth_plugin, seq_num + <span class="number">1</span>)?;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>((channel, DatabaseProvider::<span class="title function_ invoke__">from</span>(&amp;handshake.server_version)))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>User provides the connection info and get one PacketChannel(TCPStream).</li><li>Get authentication method and authenticate</li></ol><h3 id="Register-as-a-slave"><a href="#Register-as-a-slave" class="headerlink" title="Register as a slave"></a>Register as a slave</h3><p><a href="https://mariadb.com/kb/en/com_register_slave/">RegisterSlave</a></p><p>In Rust, we need to construct a message and send to the PacketChannel as above which includes</p><ul><li>COM_REGISTER_SLAVE command</li><li>server_id</li><li><strong>Empty</strong> host user password port rank masterid</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">RegisterSlaveCommand</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(server_id: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123; server_id &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">serialize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;, io::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cursor</span> = Cursor::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> vec);</span><br><span class="line"></span><br><span class="line">        cursor.<span class="title function_ invoke__">write_u8</span>(CommandType::RegisterSlave <span class="keyword">as</span> <span class="type">u8</span>)?;</span><br><span class="line">        cursor.write_u32::&lt;LittleEndian&gt;(<span class="keyword">self</span>.server_id)?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Empty host, user, password, port, rank, masterid</span></span><br><span class="line">        cursor.<span class="title function_ invoke__">write_u8</span>(<span class="number">0</span>)?;</span><br><span class="line">        cursor.<span class="title function_ invoke__">write_u8</span>(<span class="number">0</span>)?;</span><br><span class="line">        cursor.<span class="title function_ invoke__">write_u8</span>(<span class="number">0</span>)?;</span><br><span class="line">        cursor.write_u16::&lt;LittleEndian&gt;(<span class="number">0</span>)?;</span><br><span class="line">        cursor.write_u32::&lt;LittleEndian&gt;(<span class="number">0</span>)?;</span><br><span class="line">        cursor.write_u32::&lt;LittleEndian&gt;(<span class="number">0</span>)?;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(vec)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Binlog-Dump"><a href="#Binlog-Dump" class="headerlink" title="Binlog Dump"></a>Binlog Dump</h3><p>Same as RegisterSlave, DumpBinogCommand needs:</p><ul><li>server_id</li><li>binlog_filename</li><li>binlog_position</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">DumpBinlogCommand</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> server_id: <span class="type">u32</span>,</span><br><span class="line">    <span class="keyword">pub</span> binlog_filename: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> binlog_position: <span class="type">u32</span>,</span><br><span class="line">    <span class="keyword">pub</span> flags: <span class="type">u16</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">DumpBinlogCommand</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(server_id: <span class="type">u32</span>, binlog_filename: <span class="type">String</span>, binlog_position: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            server_id,</span><br><span class="line">            binlog_filename,</span><br><span class="line">            binlog_position,</span><br><span class="line">            flags: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">serialize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;, io::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cursor</span> = Cursor::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> vec);</span><br><span class="line"></span><br><span class="line">        cursor.<span class="title function_ invoke__">write_u8</span>(CommandType::BinlogDump <span class="keyword">as</span> <span class="type">u8</span>)?;</span><br><span class="line">        cursor.write_u32::&lt;LittleEndian&gt;(<span class="keyword">self</span>.binlog_position)?;</span><br><span class="line">        cursor.write_u16::&lt;LittleEndian&gt;(<span class="keyword">self</span>.flags)?;</span><br><span class="line">        cursor.write_u32::&lt;LittleEndian&gt;(<span class="keyword">self</span>.server_id)?;</span><br><span class="line">        cursor.<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.binlog_filename.<span class="title function_ invoke__">as_bytes</span>())?;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(vec)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Handle-Binlog-Events"><a href="#Handle-Binlog-Events" class="headerlink" title="Handle Binlog Events"></a>Handle Binlog Events</h3><p>As mentioned above, usually, we let users handle these events but firstly, we need to parse them.</p><h3 id="HeartBeats"><a href="#HeartBeats" class="headerlink" title="HeartBeats"></a>HeartBeats</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">set_master_heartbeat</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, channel: &amp;<span class="keyword">mut</span> PacketChannel) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">milliseconds</span> = <span class="keyword">self</span>.options.heartbeat_interval.<span class="title function_ invoke__">as_millis</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">nanoseconds</span> = milliseconds * <span class="number">1000</span> * <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">query</span> = <span class="built_in">format!</span>(<span class="string">&quot;set @master_heartbeat_period=&#123;&#125;&quot;</span>, nanoseconds);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">command</span> = QueryCommand::<span class="title function_ invoke__">new</span>(query.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">    channel.<span class="title function_ invoke__">write_packet</span>(&amp;command.<span class="title function_ invoke__">serialize</span>()?, <span class="number">0</span>)?;</span><br><span class="line">    <span class="keyword">let</span> (packet, _) = channel.<span class="title function_ invoke__">read_packet</span>()?;</span><br><span class="line">    <span class="title function_ invoke__">check_error_packet</span>(&amp;packet, <span class="string">&quot;Setting master heartbeat error.&quot;</span>)?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Get-Better-Performance"><a href="#Get-Better-Performance" class="headerlink" title="Get Better Performance"></a>Get Better Performance</h3><p>As we know, it is impossible for a CDC program to pull and parse binlog events infinitely as a slave. Also, as a developer, you may be not able to adjust the MySQL server parameters to improve the CDC performance. There are some suggestions for you if you are trouble with any relationed issues.</p><h4 id="Batch-Processing"><a href="#Batch-Processing" class="headerlink" title="Batch-Processing"></a>Batch-Processing</h4><p>For the only slave, you can use batch processing anywhere except pulling binlog events like <strong>parse events</strong>, <strong>handle events</strong> or <strong>sink the events.</strong> There is an example that I used in parsing binlog events.</p><ol><li>Parser for parsing a single binlog events</li></ol><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">read_data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> io::<span class="type">Result</span>&lt;<span class="type">Option</span>&lt;EventData&lt;<span class="symbol">&#x27;_</span>&gt;&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">use</span> EventType::*;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">event_type</span> = <span class="keyword">match</span> <span class="keyword">self</span>.header.event_type.<span class="title function_ invoke__">get</span>() &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(event_type) =&gt; event_type,</span><br><span class="line">            _ =&gt; <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="literal">None</span>),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">event_data</span> = <span class="keyword">match</span> event_type &#123;</span><br><span class="line">            ENUM_END_EVENT | UNKNOWN_EVENT =&gt; EventData::UnknownEvent,</span><br><span class="line">            START_EVENT_V3 =&gt; EventData::<span class="title function_ invoke__">StartEventV3</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            QUERY_EVENT =&gt; EventData::<span class="title function_ invoke__">QueryEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            STOP_EVENT =&gt; EventData::StopEvent,</span><br><span class="line">            ROTATE_EVENT =&gt; EventData::<span class="title function_ invoke__">RotateEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            INTVAR_EVENT =&gt; EventData::<span class="title function_ invoke__">IntvarEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            LOAD_EVENT =&gt; EventData::<span class="title function_ invoke__">LoadEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            SLAVE_EVENT =&gt; EventData::SlaveEvent,</span><br><span class="line">            CREATE_FILE_EVENT =&gt; EventData::<span class="title function_ invoke__">CreateFileEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            APPEND_BLOCK_EVENT =&gt; EventData::<span class="title function_ invoke__">AppendBlockEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            EXEC_LOAD_EVENT =&gt; EventData::<span class="title function_ invoke__">ExecLoadEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            DELETE_FILE_EVENT =&gt; EventData::<span class="title function_ invoke__">DeleteFileEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            NEW_LOAD_EVENT =&gt; EventData::<span class="title function_ invoke__">NewLoadEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            RAND_EVENT =&gt; EventData::<span class="title function_ invoke__">RandEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            USER_VAR_EVENT =&gt; EventData::<span class="title function_ invoke__">UserVarEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            FORMAT_DESCRIPTION_EVENT =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">fde</span> = <span class="keyword">self</span></span><br><span class="line">                    .read_event::&lt;FormatDescriptionEvent&gt;()?</span><br><span class="line">                    .<span class="title function_ invoke__">with_footer</span>(<span class="keyword">self</span>.footer);</span><br><span class="line">                EventData::<span class="title function_ invoke__">FormatDescriptionEvent</span>(fde)</span><br><span class="line">            &#125;</span><br><span class="line">            XID_EVENT =&gt; EventData::<span class="title function_ invoke__">XidEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            BEGIN_LOAD_QUERY_EVENT =&gt; EventData::<span class="title function_ invoke__">BeginLoadQueryEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            EXECUTE_LOAD_QUERY_EVENT =&gt; EventData::<span class="title function_ invoke__">ExecuteLoadQueryEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            TABLE_MAP_EVENT =&gt; EventData::<span class="title function_ invoke__">TableMapEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            PRE_GA_WRITE_ROWS_EVENT =&gt; EventData::<span class="title function_ invoke__">PreGaWriteRowsEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            PRE_GA_UPDATE_ROWS_EVENT =&gt; EventData::<span class="title function_ invoke__">PreGaUpdateRowsEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            PRE_GA_DELETE_ROWS_EVENT =&gt; EventData::<span class="title function_ invoke__">PreGaDeleteRowsEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            WRITE_ROWS_EVENT_V1 =&gt; &#123;</span><br><span class="line">                EventData::<span class="title function_ invoke__">RowsEvent</span>(RowsEventData::<span class="title function_ invoke__">WriteRowsEventV1</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?))</span><br><span class="line">            &#125;</span><br><span class="line">            UPDATE_ROWS_EVENT_V1 =&gt; &#123;</span><br><span class="line">                EventData::<span class="title function_ invoke__">RowsEvent</span>(RowsEventData::<span class="title function_ invoke__">UpdateRowsEventV1</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?))</span><br><span class="line">            &#125;</span><br><span class="line">            DELETE_ROWS_EVENT_V1 =&gt; &#123;</span><br><span class="line">                EventData::<span class="title function_ invoke__">RowsEvent</span>(RowsEventData::<span class="title function_ invoke__">DeleteRowsEventV1</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?))</span><br><span class="line">            &#125;</span><br><span class="line">            INCIDENT_EVENT =&gt; EventData::<span class="title function_ invoke__">IncidentEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            HEARTBEAT_EVENT =&gt; EventData::HeartbeatEvent,</span><br><span class="line">            IGNORABLE_EVENT =&gt; EventData::<span class="title function_ invoke__">IgnorableEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            ROWS_QUERY_EVENT =&gt; EventData::<span class="title function_ invoke__">RowsQueryEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            WRITE_ROWS_EVENT =&gt; &#123;</span><br><span class="line">                EventData::<span class="title function_ invoke__">RowsEvent</span>(RowsEventData::<span class="title function_ invoke__">WriteRowsEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?))</span><br><span class="line">            &#125;</span><br><span class="line">            UPDATE_ROWS_EVENT =&gt; &#123;</span><br><span class="line">                EventData::<span class="title function_ invoke__">RowsEvent</span>(RowsEventData::<span class="title function_ invoke__">UpdateRowsEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?))</span><br><span class="line">            &#125;</span><br><span class="line">            DELETE_ROWS_EVENT =&gt; &#123;</span><br><span class="line">                EventData::<span class="title function_ invoke__">RowsEvent</span>(RowsEventData::<span class="title function_ invoke__">DeleteRowsEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?))</span><br><span class="line">            &#125;</span><br><span class="line">            GTID_EVENT =&gt; EventData::<span class="title function_ invoke__">GtidEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            ANONYMOUS_GTID_EVENT =&gt; EventData::<span class="title function_ invoke__">AnonymousGtidEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">            PREVIOUS_GTIDS_EVENT =&gt; EventData::<span class="title function_ invoke__">PreviousGtidsEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            TRANSACTION_CONTEXT_EVENT =&gt; &#123;</span><br><span class="line">                EventData::<span class="title function_ invoke__">TransactionContextEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data))</span><br><span class="line">            &#125;</span><br><span class="line">            VIEW_CHANGE_EVENT =&gt; EventData::<span class="title function_ invoke__">ViewChangeEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            XA_PREPARE_LOG_EVENT =&gt; EventData::<span class="title function_ invoke__">XaPrepareLogEvent</span>(Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;*<span class="keyword">self</span>.data)),</span><br><span class="line">            PARTIAL_UPDATE_ROWS_EVENT =&gt; &#123;</span><br><span class="line">                EventData::<span class="title function_ invoke__">RowsEvent</span>(RowsEventData::<span class="title function_ invoke__">PartialUpdateRowsEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?))</span><br><span class="line">            &#125;</span><br><span class="line">            TRANSACTION_PAYLOAD_EVENT =&gt; EventData::<span class="title function_ invoke__">TransactionPayloadEvent</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>()?),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(<span class="title function_ invoke__">Some</span>(event_data))</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol><li>Use the Rayon framework to enable concurrency</li></ol><p>Many operations in Rayon, such as map(), filter_map(), and others, do not inherently guarantee that the output order will be the same as the input order. However, when used in combination with collect(), they generally ensure the results are in order. So, if the order of data is needed, please write a test case to test your code.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="variable">result</span> <span class="keyword">in</span> client.<span class="title function_ invoke__">replicate</span>()? &#123;</span><br><span class="line">        <span class="keyword">let</span> (header, event) = result?;</span><br><span class="line">        event_queue.<span class="title function_ invoke__">enqueue</span>((header, event));</span><br><span class="line">        event_count += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> event_count.<span class="title function_ invoke__">borrow</span>() % <span class="number">100000</span> == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">event_array</span> = event_queue.<span class="title function_ invoke__">drain_all</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">new_arr</span>: <span class="type">Vec</span>&lt;(EventHeader, <span class="type">Result</span>&lt;BinlogEvent, Error&gt;)&gt; = event_array.<span class="title function_ invoke__">into_par_iter</span>().<span class="title function_ invoke__">map</span>(|(header, payload)| &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">c_table_map</span> = table_map.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">parsed_event</span> = <span class="title function_ invoke__">parse_event</span>(&amp;header, &amp;payload, &amp;<span class="keyword">mut</span> c_table_map);</span><br><span class="line">                (header, parsed_event)</span><br><span class="line">            &#125;).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">dur</span> = start_time.<span class="title function_ invoke__">elapsed</span>();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Process Time Duration: &#123;:?&#125;&quot;</span>, dur);</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Current Binlog Events: &#123;:?&#125;&quot;</span>, event_count);</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Result Length: &#123;:?&#125;&quot;</span>, new_arr.<span class="title function_ invoke__">len</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol><li>Choose the needed events</li></ol><p>Normally, in CDC program, several binlog event types are as follows:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[allow(non_camel_case_types)]</span></span><br><span class="line"><span class="meta">#[repr(u8)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone, Copy, Eq, PartialEq, Hash)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">EventType</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A `QUERY_EVENT` is created for each query that modifies the database,</span></span><br><span class="line">    <span class="comment">/// unless the query is logged row-based.</span></span><br><span class="line">    QUERY_EVENT = <span class="number">0x02</span>,</span><br><span class="line">    <span class="comment">/// to tell the reader what binlog to request next.</span></span><br><span class="line">    ROTATE_EVENT = <span class="number">0x04</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// if any transaction commit info needed</span></span><br><span class="line">    XID_EVENT = <span class="number">0x10</span>,</span><br><span class="line">  </span><br><span class="line">    TABLE_MAP_EVENT = <span class="number">0x13</span>,</span><br><span class="line">   </span><br><span class="line">    WRITE_ROWS_EVENT_V1 = <span class="number">0x17</span>,</span><br><span class="line">    UPDATE_ROWS_EVENT_V1 = <span class="number">0x18</span>,</span><br><span class="line">    DELETE_ROWS_EVENT_V1 = <span class="number">0x19</span>,</span><br><span class="line">  </span><br><span class="line">    WRITE_ROWS_EVENT = <span class="number">0x1e</span>,</span><br><span class="line">    UPDATE_ROWS_EVENT = <span class="number">0x1f</span>,</span><br><span class="line">    DELETE_ROWS_EVENT = <span class="number">0x20</span>,</span><br><span class="line">    GTID_EVENT = <span class="number">0x21</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>Add iterator for your binlog stream reader</li></ol><p>In my code, <code>client.replicate()</code> will return <code>Result&lt;BinlogEvents, Error&gt;</code>. So we need to implement Iterator trait for BinlogEvents.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator</span> <span class="keyword">for</span> <span class="title class_">BinlogEvents</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span> = <span class="type">Result</span>&lt;(EventHeader, <span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;), Error&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Reads binlog event packets from network stream.</span></span><br><span class="line">    <span class="comment">/// &lt;a href=&quot;https://mariadb.com/kb/en/3-binlog-network-stream/&quot;&gt;See more&lt;/a&gt;</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> (packet, _) = <span class="keyword">match</span> <span class="keyword">self</span>.channel.<span class="title function_ invoke__">read_packet</span>() &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(x) =&gt; x,</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="title function_ invoke__">Some</span>(<span class="title function_ invoke__">Err</span>(Error::<span class="title function_ invoke__">IoError</span>(e))),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">match</span> packet[<span class="number">0</span>] &#123;</span><br><span class="line">            ResponseType::OK =&gt; <span class="title function_ invoke__">Some</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_event</span>(&amp;packet)),</span><br><span class="line">            ResponseType::ERROR =&gt; <span class="title function_ invoke__">Some</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">read_error</span>(&amp;packet)),</span><br><span class="line">            ResponseType::END_OF_FILE =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">_</span> = EndOfFilePacket::<span class="title function_ invoke__">parse</span>(&amp;packet[<span class="number">1</span>..]);</span><br><span class="line">                <span class="literal">None</span></span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; <span class="title function_ invoke__">Some</span>(<span class="title function_ invoke__">Err</span>(Error::<span class="title function_ invoke__">String</span>(</span><br><span class="line">                <span class="string">&quot;Unknown network stream status&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            ))),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In another case, the binlog stream reader implements the Stream trait like <code>while let Ok(Some(c)) = cdc_stream.try_next().await</code>.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">futures_core</span>::stream::Stream <span class="keyword">for</span> <span class="title class_">BinlogStream</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span> = <span class="type">Result</span>&lt;ChgcapEvent&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">poll_next</span>(</span><br><span class="line">        <span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;,</span><br><span class="line">        cx: &amp;<span class="keyword">mut</span> std::task::Context&lt;<span class="symbol">&#x27;_</span>&gt;,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> Poll&lt;<span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">this</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">get_mut</span>();</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Support rate limiting.</span></span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">binlog_stream</span> = Pin::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> this.binlog_stream);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">match</span> binlog_stream.<span class="title function_ invoke__">poll_next</span>(cx) &#123;</span><br><span class="line">                Poll::<span class="title function_ invoke__">Ready</span>(t) =&gt; <span class="keyword">match</span> t &#123;</span><br><span class="line">                    <span class="title function_ invoke__">Some</span>(event_result) =&gt; <span class="keyword">match</span> event_result &#123;</span><br><span class="line">                        <span class="title function_ invoke__">Ok</span>(event) =&gt; <span class="keyword">match</span> this.<span class="title function_ invoke__">handle_event</span>(event) &#123; <span class="comment">// here</span></span><br><span class="line">                            <span class="title function_ invoke__">Ok</span>(change) =&gt; <span class="keyword">match</span> change &#123;</span><br><span class="line">                                <span class="title function_ invoke__">Some</span>(c) =&gt; Poll::<span class="title function_ invoke__">Ready</span>(<span class="title function_ invoke__">Some</span>(<span class="title function_ invoke__">Ok</span>(c))),</span><br><span class="line">                                <span class="literal">None</span> =&gt; <span class="keyword">continue</span>, <span class="comment">// Skip this event.</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="title function_ invoke__">Err</span>(e) =&gt; Poll::<span class="title function_ invoke__">Ready</span>(<span class="title function_ invoke__">Some</span>(<span class="title function_ invoke__">Err</span>(e))),</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="title function_ invoke__">Err</span>(err) =&gt; Poll::<span class="title function_ invoke__">Ready</span>(<span class="title function_ invoke__">Some</span>(<span class="title function_ invoke__">Err</span>(anyhow!(err)))),</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="literal">None</span> =&gt; Poll::<span class="title function_ invoke__">Ready</span>(<span class="literal">None</span>), <span class="comment">// Completed.</span></span><br><span class="line">                &#125;,</span><br><span class="line">                Poll::Pending =&gt; Poll::Pending,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>Accumulate unprocessed binlog events into a batch like Step 2</li></ol><h4 id="Multiple-Slave"><a href="#Multiple-Slave" class="headerlink" title="Multiple Slave"></a>Multiple Slave</h4><p>In <strong>Batch-Processing</strong> section, we can boost the performance of CDC from tens of thousands of events to over a hundred thousand events per second. But however, if you need higher performance, single-instance batching may not meet your needs.</p><p>Luckily, there is an another road to make it. Before introducing this way, let us take eyes on <strong>table_id</strong>.</p><ul><li>table_id is 6 bytes, need pad little-endian number.</li><li>table_id is a temporary value. it would be changed when:<ul><li>drop and replace table</li><li>rename table</li><li>alter table</li><li>MySQL Engine upgrade</li></ul></li><li>Before every data change events(WriteRowsEvent, UpdateRowsEvent, DeleteRowsEvent), there would be a TableMapEvent including table name, table id and table schema.</li></ul><p>Next, you should know how to get table metadata from TableMapEvent.</p><p><img src="/2023/12/21/mysql-cdc/table_map_event.png" alt="TableMapEvent"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TableMapEvent</span>(<span class="title class_ inherited__">BinLogEvent</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;This event describes the structure of a table.</span></span><br><span class="line"><span class="string">    It&#x27;s sent before a change happens on a table.</span></span><br><span class="line"><span class="string">    An end user of the lib should have no usage of this</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, from_packet, event_size, table_map, ctl_connection, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(TableMapEvent, self).__init__(from_packet, event_size,</span><br><span class="line">                                            table_map, ctl_connection, **kwargs)</span><br><span class="line">        self.__only_tables = kwargs[<span class="string">&quot;only_tables&quot;</span>]</span><br><span class="line">        self.__ignored_tables = kwargs[<span class="string">&quot;ignored_tables&quot;</span>]</span><br><span class="line">        self.__only_schemas = kwargs[<span class="string">&quot;only_schemas&quot;</span>]</span><br><span class="line">        self.__ignored_schemas = kwargs[<span class="string">&quot;ignored_schemas&quot;</span>]</span><br><span class="line">        self.__freeze_schema = kwargs[<span class="string">&quot;freeze_schema&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Post-Header</span></span><br><span class="line">        self.table_id = self._read_table_id()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.table_id <span class="keyword">in</span> table_map <span class="keyword">and</span> self.__freeze_schema:</span><br><span class="line">            self._processed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        self.flags = struct.unpack(<span class="string">&#x27;&lt;H&#x27;</span>, self.packet.read(<span class="number">2</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Payload</span></span><br><span class="line">        self.schema_length = struct.unpack(<span class="string">&quot;!B&quot;</span>, self.packet.read(<span class="number">1</span>))[<span class="number">0</span>]</span><br><span class="line">        self.schema = self.packet.read(self.schema_length).decode()</span><br><span class="line">        self.packet.advance(<span class="number">1</span>)</span><br><span class="line">        self.table_length = struct.unpack(<span class="string">&quot;!B&quot;</span>, self.packet.read(<span class="number">1</span>))[<span class="number">0</span>]</span><br><span class="line">        self.table = self.packet.read(self.table_length).decode()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.__only_tables <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.table <span class="keyword">not</span> <span class="keyword">in</span> self.__only_tables:</span><br><span class="line">            self._processed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">elif</span> self.__ignored_tables <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.table <span class="keyword">in</span> self.__ignored_tables:</span><br><span class="line">            self._processed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.__only_schemas <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.schema <span class="keyword">not</span> <span class="keyword">in</span> self.__only_schemas:</span><br><span class="line">            self._processed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">elif</span> self.__ignored_schemas <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.schema <span class="keyword">in</span> self.__ignored_schemas:</span><br><span class="line">            self._processed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        self.packet.advance(<span class="number">1</span>)</span><br><span class="line">        self.column_count = self.packet.read_length_coded_binary()</span><br><span class="line"></span><br><span class="line">        self.columns = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.table_id <span class="keyword">in</span> table_map:</span><br><span class="line">            self.column_schemas = table_map[self.table_id].column_schemas</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.column_schemas = self._ctl_connection._get_table_information(self.schema, self.table)</span><br><span class="line"></span><br><span class="line">        ordinal_pos_loc = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.column_schemas) != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># Read columns meta data</span></span><br><span class="line">            column_types = <span class="built_in">bytearray</span>(self.packet.read(self.column_count))</span><br><span class="line">            self.packet.read_length_coded_binary()</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(column_types)):</span><br><span class="line">                column_type = column_types[i]</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    column_schema = self.column_schemas[ordinal_pos_loc]</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># only acknowledge the column definition if the iteration matches with ordinal position of</span></span><br><span class="line">                    <span class="comment"># the column. this helps in maintaining support for restricted columnar access</span></span><br><span class="line">                    <span class="keyword">if</span> i != (column_schema[<span class="string">&#x27;ORDINAL_POSITION&#x27;</span>] - <span class="number">1</span>):</span><br><span class="line">                        <span class="comment"># raise IndexError to follow the workflow of dropping columns which are not matching the</span></span><br><span class="line">                        <span class="comment"># underlying table schema</span></span><br><span class="line">                        <span class="keyword">raise</span> IndexError</span><br><span class="line"></span><br><span class="line">                    ordinal_pos_loc += <span class="number">1</span></span><br><span class="line">                <span class="keyword">except</span> IndexError:</span><br><span class="line">                    <span class="comment"># this a dirty hack to prevent row events containing columns which have been dropped prior</span></span><br><span class="line">                    <span class="comment"># to pymysqlreplication start, but replayed from binlog from blowing up the service.</span></span><br><span class="line">                    <span class="comment"># <span class="doctag">TODO:</span> this does not address the issue if the column other than the last one is dropped</span></span><br><span class="line">                    column_schema = &#123;</span><br><span class="line">                        <span class="string">&#x27;COLUMN_NAME&#x27;</span>: <span class="string">&#x27;__dropped_col_&#123;i&#125;__&#x27;</span>.<span class="built_in">format</span>(i=i),</span><br><span class="line">                        <span class="string">&#x27;COLLATION_NAME&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">                        <span class="string">&#x27;CHARACTER_SET_NAME&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">                        <span class="string">&#x27;COLUMN_COMMENT&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">                        <span class="string">&#x27;COLUMN_TYPE&#x27;</span>: <span class="string">&#x27;BLOB&#x27;</span>,  <span class="comment"># we don&#x27;t know what it is, so let&#x27;s not do anything with it.</span></span><br><span class="line">                        <span class="string">&#x27;COLUMN_KEY&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                    &#125;</span><br><span class="line">                col = Column(column_type, column_schema, from_packet)</span><br><span class="line">                self.columns.append(col)</span><br><span class="line"></span><br><span class="line">        self.table_obj = Table(self.column_schemas, self.table_id, self.schema,</span><br><span class="line">                               self.table, self.columns)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ith column is nullable if (i - 1)th bit is set to True, not nullable otherwise</span></span><br><span class="line">        <span class="comment">## Refer to definition of and call to row.event._is_null() to interpret bitmap corresponding to columns</span></span><br><span class="line">        self.null_bitmask = self.packet.read((self.column_count + <span class="number">7</span>) / <span class="number">8</span>)</span><br></pre></td></tr></table></figure><p>Congratulations! You have known how to divide your binlog stream reader to different database(schema) / table.</p><p><img src="/2023/12/21/mysql-cdc/row_events.png" alt="RowEvents"></p><p>For TableMapEvent, we can store the table_id for the RowEvents. When any RowEvents parse the table_id and it is not in the table map cache, the event should be ignored.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RowsEvent</span>(<span class="title class_ inherited__">BinLogEvent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, from_packet, event_size, table_map, ctl_connection, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(RowsEvent, self).__init__(from_packet, event_size, table_map,</span><br><span class="line">                                        ctl_connection, **kwargs)</span><br><span class="line">        self.__rows = <span class="literal">None</span></span><br><span class="line">        self.__only_tables = kwargs[<span class="string">&quot;only_tables&quot;</span>]</span><br><span class="line">        self.__ignored_tables = kwargs[<span class="string">&quot;ignored_tables&quot;</span>]</span><br><span class="line">        self.__only_schemas = kwargs[<span class="string">&quot;only_schemas&quot;</span>]</span><br><span class="line">        self.__ignored_schemas = kwargs[<span class="string">&quot;ignored_schemas&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment">#Header</span></span><br><span class="line">        self.table_id = self._read_table_id()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Additional information</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.primary_key = table_map[self.table_id].data[<span class="string">&quot;primary_key&quot;</span>]</span><br><span class="line">            self.schema = self.table_map[self.table_id].schema</span><br><span class="line">            self.table = self.table_map[self.table_id].table</span><br><span class="line">        <span class="keyword">except</span> KeyError: <span class="comment">#If we have filter the corresponding TableMap Event</span></span><br><span class="line">            self._processed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.__only_tables <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.table <span class="keyword">not</span> <span class="keyword">in</span> self.__only_tables:</span><br><span class="line">            self._processed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">elif</span> self.__ignored_tables <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.table <span class="keyword">in</span> self.__ignored_tables:</span><br><span class="line">            self._processed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.__only_schemas <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.schema <span class="keyword">not</span> <span class="keyword">in</span> self.__only_schemas:</span><br><span class="line">            self._processed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">elif</span> self.__ignored_schemas <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.schema <span class="keyword">in</span> self.__ignored_schemas:</span><br><span class="line">            self._processed = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">#Event V2</span></span><br><span class="line">        <span class="keyword">if</span> self.event_type == BINLOG.WRITE_ROWS_EVENT_V2 <span class="keyword">or</span> \</span><br><span class="line">                self.event_type == BINLOG.DELETE_ROWS_EVENT_V2 <span class="keyword">or</span> \</span><br><span class="line">                self.event_type == BINLOG.UPDATE_ROWS_EVENT_V2:</span><br><span class="line">                self.flags, self.extra_data_length = struct.unpack(<span class="string">&#x27;&lt;HH&#x27;</span>, self.packet.read(<span class="number">4</span>))</span><br><span class="line">                <span class="keyword">if</span> self.extra_data_length &gt; <span class="number">2</span>:</span><br><span class="line">                    self.extra_data_type = struct.unpack(<span class="string">&#x27;&lt;B&#x27;</span>, self.packet.read(<span class="number">1</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># ndb information</span></span><br><span class="line">                    <span class="keyword">if</span> self.extra_data_type == <span class="number">0</span>:</span><br><span class="line">                        self.nbd_info_length, self.nbd_info_format = struct.unpack(<span class="string">&#x27;&lt;BB&#x27;</span>, self.packet.read(<span class="number">1</span>))</span><br><span class="line">                        self.nbd_info = self.packet.read(self.nbd_info_length - <span class="number">2</span>)</span><br><span class="line">                    <span class="comment"># partition information</span></span><br><span class="line">                    <span class="keyword">elif</span> self.extra_data_type == <span class="number">1</span>:</span><br><span class="line">                        <span class="keyword">if</span> self.event_type == BINLOG.UPDATE_ROWS_EVENT_V2:</span><br><span class="line">                            self.partition_id, self.source_partition_id = struct.unpack(<span class="string">&#x27;&lt;HH&#x27;</span>, self.packet.read(<span class="number">4</span>))</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            self.partition_id = struct.unpack(<span class="string">&#x27;&lt;H&#x27;</span>, self.packet.read(<span class="number">2</span>))[<span class="number">0</span>]</span><br><span class="line">                    <span class="comment"># etc</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        self.extra_data = self.packet.read(self.extra_info_length - <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.flags = struct.unpack(<span class="string">&#x27;&lt;H&#x27;</span>, self.packet.read(<span class="number">2</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment">#Body</span></span><br><span class="line">        self.number_of_columns = self.packet.read_length_coded_binary()</span><br><span class="line">        self.columns = self.table_map[self.table_id].columns</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.columns) == <span class="number">0</span>:  <span class="comment"># could not read the table metadata, probably already dropped</span></span><br><span class="line">            self.complete = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">if</span> self._fail_on_table_metadata_unavailable:</span><br><span class="line">                <span class="keyword">raise</span> TableMetadataUnavailableError(self.table)</span><br></pre></td></tr></table></figure><p>Across fitering the database/table, you can store the table ID into table map cache what you want when parsing TableMapEvent. For the CDC program, it only needs to parse the Header(to get table ID) of the RowEvents. Then, continue to handle the events if it is in the table map or just drop them if not.</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li><a href="https://arxiv.org/pdf/2010.12597.pdf">https://arxiv.org/pdf/2010.12597.pdf</a></li><li><a href="https://github.com/blackbeam/mysql_async">https://github.com/blackbeam/mysql_async</a></li><li><a href="https://github.com/neverchanje/chgcap-rs">https://github.com/neverchanje/chgcap-rs</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;CDC-Process&quot;&gt;&lt;a href=&quot;#CDC-Process&quot; class=&quot;headerlink&quot; title=&quot;CDC Process&quot;&gt;&lt;/a&gt;CDC Process&lt;/h2&gt;&lt;p&gt;A common binlog stream reader cont</summary>
      
    
    
    
    
    <category term="cdc mysql binlog" scheme="https://adooobe.github.io/tags/cdc-mysql-binlog/"/>
    
  </entry>
  
  <entry>
    <title>Snowflake CDC VS Hudi CDC</title>
    <link href="https://adooobe.github.io/2023/10/30/snowflake-stream/"/>
    <id>https://adooobe.github.io/2023/10/30/snowflake-stream/</id>
    <published>2023-10-30T01:55:24.000Z</published>
    <updated>2024-04-08T06:51:58.398Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Batch-vs-Streaming"><a href="#Batch-vs-Streaming" class="headerlink" title="Batch vs. Streaming"></a>Batch vs. Streaming</h2><p>Batch and streaming are different ways to treat data transformation. We usually talk about <code>Flow-Batch integration</code> artitechture but I have not seen any applications which can do self-adaption batch or streaming operation in the same semantic and I totally agree the point of view proposed by <a href="https://dl.acm.org/doi/pdf/10.1145/3589776">this article</a>.</p><blockquote><p>batch systems process input datasets in their entirety to produce new output datasets in their entirety.</p><p>streaming systems process the changes to input datasets over time to incrementally evolve their corresponding outputs over time.</p></blockquote><p>In my opinion, streaming systems combine the data and time semantic but batch systems only concerns about data. It leads to a new physical concept: <code>changes</code>. In Snowflake, <code>Streams</code> are based on <code>changes</code> which capture the changes to a dataset over time.</p><p>As for ETL pipeline, streaming or batch is depedent on the compute engine. If we use Flink for Hudi CDC, the pipeline is streaming but micro-batch with Spark. Unluckily, Snowflake does not yet have mature streaming capabilities ( I’m not so familiar with the implementation of Dynamic Table)</p><h2 id="MySQL-redo-log"><a href="#MySQL-redo-log" class="headerlink" title="MySQL redo log"></a>MySQL redo log</h2><p>Firstly, let us talk about what is redo log and why we need redo log.</p><p>In MySQL design, to avoid disk operation each DML and load data from disk each query statement, there is a <code>buffer pool</code> to reduce disk I/O and mySQL will query the adjacent data of aiming data, then put them into buffer pool as one page.</p><p>However, when we make changes to the data in the buffer pool, the buffer pool does not immediately flush data into disk, resulting in inconsistency between the data in the buffer pool and the data on the disk. It is called a dirty page. If MySQL crashed when dirty page happened, ACID was destroyed.</p><p><img src="/2023/10/30/snowflake-stream/buffer_pool.png#pic_center" alt="buffer pool"></p><h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p>!!! note Test-Hexo-Plugin<br>hello</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li><a href="https://dl.acm.org/doi/pdf/10.1145/3589776">https://dl.acm.org/doi/pdf/10.1145/3589776</a></li><li><a href="https://15445.courses.cs.cmu.edu/fall2021/notes/05-bufferpool.pdf">https://15445.courses.cs.cmu.edu/fall2021/notes/05-bufferpool.pdf</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Batch-vs-Streaming&quot;&gt;&lt;a href=&quot;#Batch-vs-Streaming&quot; class=&quot;headerlink&quot; title=&quot;Batch vs. Streaming&quot;&gt;&lt;/a&gt;Batch vs. Streaming&lt;/h2&gt;&lt;p&gt;Batc</summary>
      
    
    
    
    
    <category term="stream cdc snowflake" scheme="https://adooobe.github.io/tags/stream-cdc-snowflake/"/>
    
  </entry>
  
  <entry>
    <title>hudi-cdc</title>
    <link href="https://adooobe.github.io/2023/10/23/hudi-cdc/"/>
    <id>https://adooobe.github.io/2023/10/23/hudi-cdc/</id>
    <published>2023-10-23T03:16:06.000Z</published>
    <updated>2024-01-15T07:41:39.746Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Two-choices"><a href="#Two-choices" class="headerlink" title="Two choices"></a>Two choices</h2><h3 id="Diff"><a href="#Diff" class="headerlink" title="Diff"></a>Diff</h3><ul><li>Based on Time-Travel</li><li>Without any redundant data</li><li>Low query performance</li><li>Improved by data split(file, bucket .etc)</li></ul><h3 id="CDF"><a href="#CDF" class="headerlink" title="CDF"></a>CDF</h3><ul><li>Need addtional metadata column and writing cost</li><li>Better query performance</li></ul><p>In CDF(DeltaLake, Hudi, Databend and Snowflake all chose CDF as CDC implementation), there are also some aspects that require our careful consideration as follows:</p><ul><li>when to persistence：we have a large number of different operators applied in the database system; we need to identify which ones require the CDC (Change Data Capture) hidden columns to be persisted.</li><li>Write: Regarding different types of write operations in various lake formats, the corresponding changes in file metadata should be clarified. The first point that can be optimized under the CDF scheme is to determine, based on different operations, whether there is a need to persist CDC data. This means that some operation’s change information is directly read from the CDC file, while for other operations, the modification information is extracted and converted from the ordinary data files. However, as each lake format has its own definition for different operations, a detailed analysis specific to the format is necessary. For instance, operations in DeltaLake like Insert Into/Insert Overwrite, Update, Delete, and Merge are what we normally understand. Meanwhile, Hudi introduces concepts like recordKey as a primary key and preCombineField for comparisons, meaning that even a simple Insert Into SQL syntax might actually correspond to an Update operation in practical logic.<ul><li>For the Insert Into operation, DeltaLake does not read any other existing files, but only adds new data files. As such, when executing the Insert Into operation under the CDF framework with DeltaLake, there is no need for additional data persistence; one only needs to load these batch files at query time and transform the data into the agreed output format. However, within Hudi, because of the logic that combines data or optimizes by writing data into existing small files, it is necessary to read and rewrite existing files; thus, persistence of CDC data is required.</li><li>For the drop partition operation, both DeltaLake (not supported by the community version, but supported by Alibaba Cloud’s EMR version) and Hudi directly mark all data files in that partition as deleted. There is no need to persist any information; during querying, these files are identified, loaded, and each record is marked as a delete operation type, along with other information such as timestamps.</li><li>For the update operation, the most fundamental operation must be to load the data files that meet the where condition, update the data that satisfies the where condition, and then write the updated data along with the unmodified data directly into a new file. In this case, an expansion of the CDF (Capability Data File) capability is required.</li></ul></li><li>Read:</li></ul><h2 id="Databend"><a href="#Databend" class="headerlink" title="Databend"></a>Databend</h2><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li><a href="https://github.com/apache/hudi/blob/master/rfc/rfc-51/rfc-51.md#approvers">https://github.com/apache/hudi/blob/master/rfc/rfc-51/rfc-51.md#approvers</a></li><li><a href="https://github.com/apache/hudi/pull/5885/commits">https://github.com/apache/hudi/pull/5885/commits</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Two-choices&quot;&gt;&lt;a href=&quot;#Two-choices&quot; class=&quot;headerlink&quot; title=&quot;Two choices&quot;&gt;&lt;/a&gt;Two choices&lt;/h2&gt;&lt;h3 id=&quot;Diff&quot;&gt;&lt;a href=&quot;#Diff&quot; class=&quot;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>z-order</title>
    <link href="https://adooobe.github.io/2023/10/19/z-order/"/>
    <id>https://adooobe.github.io/2023/10/19/z-order/</id>
    <published>2023-10-19T05:33:09.000Z</published>
    <updated>2024-04-08T04:41:20.415Z</updated>
    
    <content type="html"><![CDATA[<h2 id="What-is-Z-order-amp-Why-Z-order"><a href="#What-is-Z-order-amp-Why-Z-order" class="headerlink" title="What is Z-order &amp; Why Z-order"></a>What is Z-order &amp; Why Z-order</h2><p>Z-order is a concept of sorting data. Specifically，to quote Wikipedia, <code>“Z-order maps multidimensional data to one dimension while preserving locality of the data points.”</code> In the field of big data, Columns in table are regarded as dimensions to some extension. In other words, Z-order brings us a better way to organize data.</p><p>Firstly, let’s think about two different ordered data, Z-order data and Linear-order data.</p><p><img src="/2023/10/19/z-order/z-order.png#pic_center" alt="z-order data"></p><p><img src="/2023/10/19/z-order/linear-order.png#pic_center" alt="linear-order data"></p><p>It is difficult for us to determine which one performs better immediately so there is a simple example to examine why z-order data may be the better one.</p><div class="table-container"><table><thead><tr><th style="text-align:center">x</th><th style="text-align:center">y</th><th style="text-align:center">z</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">3</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">3</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">3</td><td style="text-align:center">1</td></tr></tbody></table></div><p>data in z-order:</p><div class="table-container"><table><thead><tr><th style="text-align:center">x</th><th style="text-align:center">y</th><th style="text-align:center">z</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">0</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">1</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">3</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">3</td><td style="text-align:center">1</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">3</td><td style="text-align:center">1</td></tr></tbody></table></div><p>Now, think about executing a query as follows:</p><ol><li><code>select sum(z) from test where x = 2</code></li><li><code>select sum(z) from test where y = 2</code></li></ol><p>How do we know the query behavior of this SQL? Let’s figure out it in clickhouse.</p><p>default minmax index:</p><div class="table-container"><table><thead><tr><th>granule</th><th>x_min</th><th>x_max</th><th>y_min</th><th>y_max</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>3</td></tr><tr><td>1</td><td>1</td><td>1</td><td>0</td><td>2</td></tr><tr><td>2</td><td>2</td><td>2</td><td>1</td><td>3</td></tr><tr><td>3</td><td>3</td><td>3</td><td>0</td><td>3</td></tr></tbody></table></div><p>minmax index with z-order:</p><div class="table-container"><table><thead><tr><th>granule</th><th>x_min</th><th>x_max</th><th>y_min</th><th>y_max</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>1</td><td>0</td><td>0</td></tr><tr><td>1</td><td>2</td><td>3</td><td>0</td><td>1</td></tr><tr><td>2</td><td>0</td><td>1</td><td>2</td><td>3</td></tr><tr><td>3</td><td>2</td><td>3</td><td>3</td><td>3</td></tr></tbody></table></div><p>For default minmax index, we filter only one granule when filtering <code>x=2</code> and  4 granules when filtering <code>y=2</code>. For z-order data, the results are<br>2 and 2. It seems that z-order data may be litter better than default one but what if we have more than 3 dimensions filter conditions? Therefore, arranging data according to z-order can help us filter out data does not need to be read, achieving better dataskipping.</p><h2 id="Z-order-in-OLTP-amp-OLAP"><a href="#Z-order-in-OLTP-amp-OLAP" class="headerlink" title="Z-order in OLTP &amp; OLAP"></a>Z-order in OLTP &amp; OLAP</h2><p>In conclusion, Z-order in OLAP can be more popular than OLTP. There are two reasons as follows.</p><p>One is due to the order of physical data that data can only be ordered as one rule in disk. If we put data into disk ordered by primary key, it can’t be ordered by another key. It means we can’t get satisfying performance when filtering some other column as same as filtering sprimary key columns. Another one is we can create serveral B-Tree index in OLTP to replace the capabilities of z-order but OLAP not (because index in memory is too expensive for OLAP).</p><h2 id="Extension-GeoHash-VS-Morton-Code"><a href="#Extension-GeoHash-VS-Morton-Code" class="headerlink" title="Extension: GeoHash VS Morton Code"></a>Extension: GeoHash VS Morton Code</h2><ol><li><a href="https://zhuanlan.zhihu.com/p/35940647">https://zhuanlan.zhihu.com/p/35940647</a></li><li><a href="https://zhuanlan.zhihu.com/p/468542418">https://zhuanlan.zhihu.com/p/468542418</a> (z-order code, but I don’t understand:( )</li></ol><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li><a href="https://blog.cloudera.com/speeding-up-queries-with-z-order/">https://blog.cloudera.com/speeding-up-queries-with-z-order/</a></li><li><a href="https://izualzhy.cn/lakehouse-zorder">https://izualzhy.cn/lakehouse-zorder</a></li><li><a href="https://juejin.cn/post/7118344872947515428">https://juejin.cn/post/7118344872947515428</a></li><li><a href="https://zhuanlan.zhihu.com/p/491256487">https://zhuanlan.zhihu.com/p/491256487</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;What-is-Z-order-amp-Why-Z-order&quot;&gt;&lt;a href=&quot;#What-is-Z-order-amp-Why-Z-order&quot; class=&quot;headerlink&quot; title=&quot;What is Z-order &amp;amp; Why Z-or</summary>
      
    
    
    
    
    <category term="big data, index" scheme="https://adooobe.github.io/tags/big-data-index/"/>
    
  </entry>
  
  <entry>
    <title>Apache Arrow For the first time</title>
    <link href="https://adooobe.github.io/2023/10/08/apache-arrow/"/>
    <id>https://adooobe.github.io/2023/10/08/apache-arrow/</id>
    <published>2023-10-08T12:17:14.000Z</published>
    <updated>2024-04-08T02:51:39.990Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Columnar-Format"><a href="#Columnar-Format" class="headerlink" title="Columnar Format"></a>Columnar Format</h2><h2 id="Language-Agnosticism"><a href="#Language-Agnosticism" class="headerlink" title="Language Agnosticism"></a>Language Agnosticism</h2><h2 id="Vectorized-Operations"><a href="#Vectorized-Operations" class="headerlink" title="Vectorized Operations"></a>Vectorized Operations</h2><h2 id="Difference-between-Arrow-and-Parquet"><a href="#Difference-between-Arrow-and-Parquet" class="headerlink" title="Difference between Arrow and Parquet"></a>Difference between Arrow and Parquet</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Columnar-Format&quot;&gt;&lt;a href=&quot;#Columnar-Format&quot; class=&quot;headerlink&quot; title=&quot;Columnar Format&quot;&gt;&lt;/a&gt;Columnar Format&lt;/h2&gt;&lt;h2 id=&quot;Language-Agno</summary>
      
    
    
    
    
    <category term="bigdata" scheme="https://adooobe.github.io/tags/bigdata/"/>
    
  </entry>
  
  <entry>
    <title>the principle and application of LSM Tree</title>
    <link href="https://adooobe.github.io/2023/10/02/lsm-tree/"/>
    <id>https://adooobe.github.io/2023/10/02/lsm-tree/</id>
    <published>2023-10-02T11:24:02.000Z</published>
    <updated>2023-10-19T07:51:30.642Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LSM-Tree"><a href="#LSM-Tree" class="headerlink" title="LSM Tree"></a>LSM Tree</h1><blockquote><p>LSM-Tree is a kind of storage engine rather than storage format.</p></blockquote><h2 id="Feature"><a href="#Feature" class="headerlink" title="Feature"></a>Feature</h2><ul><li>Ordered</li><li>Block Storage(Disk)-oriented</li><li>Hierarchical</li></ul><h2 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h2><p><img src="/2023/10/02/lsm-tree/lsm_tree.png#pic_center" alt="LSM-Tree Structure"></p><h2 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h2><h3 id="WAL"><a href="#WAL" class="headerlink" title="WAL"></a>WAL</h3><p>When LSM Tree received a input(insert/update/delete) operation, to avoid accidental crashing or shutdown，It is neccessary to write ahead log(WAL) that saves operation records into log files.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Wal <span class="keyword">struct</span> &#123;</span><br><span class="line">f    *os.File</span><br><span class="line">path <span class="type">string</span></span><br><span class="line">lock sync.Locker</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Memtable"><a href="#Memtable" class="headerlink" title="Memtable"></a>Memtable</h3><p>Memtable is an append-only data structure (every node inserted cannot be changed by logical delete and removing duplicates based on update time.) like Binary search tree (e.g. RedBlack tree - LevelDB) or SkipList (e.g. HBase, more popular).</p><h3 id="Sorted-String-Table-SSTables"><a href="#Sorted-String-Table-SSTables" class="headerlink" title="Sorted String Table (SSTables)"></a>Sorted String Table (SSTables)</h3><p>Usually, a SSTable consists of an index block and multiple data blocks. Data block structure is as follows:</p><p><img src="/2023/10/02/lsm-tree/sstable.png#pic_center" alt="Sorted Strings Table"></p><p>where data is only ordered in segment layer rather than global.</p><h3 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h3><h4 id="improve-read-performance"><a href="#improve-read-performance" class="headerlink" title="improve read performance"></a>improve read performance</h4><p>For LSM Tree, what we concerned is read performance rather than write. As data increases, some methods to improve read performance need to come into our pictures.</p><ul><li><strong>Sparse Index</strong></li></ul><p>As mentioned above, SStable has several segments that data are orderly stored. Without any optimization, we can also use binary search algorithm to find a certain element by scanning all the SStables and every Segments in each SStable unitl finding it. But unfortunately, for binary search algorithm, the minimum memory unit is segment for us to find the key in <em>O(logn)</em> or spent a Disk IO, both are too expensive in big data scenarios. So it is neccessary to  build a sparse index in memory to accelerate query efficiency.</p><p><img src="/2023/10/02/lsm-tree/sparse_index.png#pic_center" alt="sparse index"></p><blockquote><p>Sparse indexes only contain entries for documents that have the indexed field, even if the index field contains a null value. The index skips over any document that is missing the indexed field. The index is “sparse” because it does not include all documents of a collection.</p></blockquote><ul><li><strong>Bloom Filter</strong></li></ul><p>When the number of SStable increases in Disk, if some key is not present in the records, we need to scan all the SStable to find that key. Bloom filter is to overcome this issue. Unlike sparse indexes, <a href="https://adooobe.github.io/2023/10/02/bloom/">Bloom filters</a> are designed to address the performance issues that arise when querying for non-existent keys.</p><p>It is worth noting that Bloom Filters should be updated as compaction operations because compaction will delete some tombstone data so that BF can’t work normally.</p><h3 id="Compaction"><a href="#Compaction" class="headerlink" title="Compaction"></a>Compaction</h3><h4 id="questions-in-query"><a href="#questions-in-query" class="headerlink" title="questions in query"></a>questions in query</h4><p>Let’s talk about query in LSM Tree first. There are two query methods: <em>point lookup query</em> and <em>range query</em>.</p><ul><li><strong>point lookup query</strong>: find the element what we want from new segment to old one.</li><li><strong>range query</strong>: when a big range query is executed, data have to be found in memtable, immutable memtable and multiple SSTalbes in different levels. (Notice: range query should be <strong>key range query</strong> like the follow picture)</li></ul><p><img src="/2023/10/02/lsm-tree/range_query.png#pic_center" alt="LSM Tree range query"></p><p>During range reads, the iterator will seek to the start range similar to point lookup (using Binary search with in SSTs) using<code>SeekTo()</code> call. After seeking to start range, there will be series of iterators created one for each memtable, one for each Level-0 files (because of overlapping nature of SSTs in L0) and one for each level later on. A merging iterator will collect keys from each of these iterators and gives the data in sorted order till the End range is reached.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">itr := txn.NewIterator(badger.DefaultIteratorOptions)   </span><br><span class="line"><span class="keyword">for</span> itr.Seek(<span class="string">&quot;startKey&quot;</span>); itr.Valid(); itr.Next() &#123;</span><br><span class="line">    item := itr.Item()</span><br><span class="line">    key := item.Key()</span><br><span class="line">    <span class="keyword">if</span> bytes.Compare(key, <span class="string">&quot;endKey&quot;</span>) &gt; <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// rest of the logic.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Step1. find <em>startkey</em> position (write as startPosition) by <code>seek()</code> and move sub iterator to <code>startPosition + 1</code></p><p>Step2. compare the sub iterators’ element, return the minimal value and move the itr pointer.</p><p>Step3. repeat Step2 until the returned element &gt; endkey</p><p>So in range query, as SSTables become more and more, query execution also becomes heavier and heavier.</p><h4 id="Sorted-Run"><a href="#Sorted-Run" class="headerlink" title="Sorted Run"></a>Sorted Run</h4><blockquote><p>LSM tree organizes files into several sorted runs. A sorted run consists of one or multiple <a href="https://nightlies.apache.org/flink/flink-table-store-docs-release-0.3/docs/concepts/file-layouts/#data-files">data file</a>s and each data file belongs to exactly one sorted run.</p><p><img src="/2023/10/02/lsm-tree/sorted_runs.png#pic_center" alt="sorted runs"></p><p>As you can see, different sorted runs may have overlapping primary key ranges, and may even contain the same primary key. When querying the LSM tree, all sorted runs must be combined and all records with the same primary key must be merged according to the user-specified <a href="https://nightlies.apache.org/flink/flink-table-store-docs-release-0.3/docs/features/table-types/#merge-engines">merge engine</a> and the timestamp of each record.</p></blockquote><p>In my opinion, in LSM Tree, a single logically ordered and no-repeat structure can be regarded as a <code>sorted run</code>.</p><h4 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h4><p><img src="/2023/10/02/lsm-tree/merge_policy.png#pic_center" alt="LSM Tree merge policies"></p><ul><li>tiered compaction(suitable for reads scenarios)<br><img src="/2023/10/02/lsm-tree/size_tiered_compaction.png#pic_center" alt="size_tiered_compaction"><ul><li>high read and space amplification</li><li>in each tier, storage unit(memtable/sstable in level 0) size won’t be changed unitl it is merged into next-level SSTable. The size of a single SSTable in the next level is the sum of the number of SSTables in the previous level.</li></ul></li><li>leveled compaction(suitable for writes scenarios)<ul><li>high write amplification</li><li>As shown in the following figure, each leveled level is an ordered run that consists of multiple sstables. These sstables also maintain an orderly relationship with each other. When the data size of each level reaches the upper limit, this level will merge with the run of the next level. This method combines multiple runs of the level to one, reducing the read amplification and space amplification. Also, the smaller sstables provide fine-grained task splitting and control. This way, controlling the task size is actually controlling the size of the temporary space. In other words, leveled merge policies will merge SSTables into next level with the same range to reduce space and read amplifications.</li></ul></li></ul><p><img src="/2023/10/02/lsm-tree/leveled_compaction.png#pic_center" alt="leveled compaction"></p><h2 id="Improvement"><a href="#Improvement" class="headerlink" title="Improvement"></a>Improvement</h2><ul><li><strong>bLSM</strong></li><li><strong>Diff-Index LSM</strong></li></ul><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li><a href="https://www.cnblogs.com/whuanle/p/16297025.html">https://www.cnblogs.com/whuanle/p/16297025.html</a></li><li><a href="https://www.geeksforgeeks.org/introduction-to-log-structured-merge-lsm-tree/">https://www.geeksforgeeks.org/introduction-to-log-structured-merge-lsm-tree/</a></li><li><a href="https://www.mongodb.com/docs/manual/core/index-sparse/#:~:text=Sparse%20indexes%20only%20contain%20entries,all%20documents%20of%20a%20collection">https://www.mongodb.com/docs/manual/core/index-sparse/#:~:text=Sparse%20indexes%20only%20contain%20entries,all%20documents%20of%20a%20collection</a>.</li><li><a href="https://hzhu212.github.io/posts/2d7c5edb/">https://hzhu212.github.io/posts/2d7c5edb/</a></li><li><a href="https://www.alibabacloud.com/blog/an-in-depth-discussion-on-the-lsm-compaction-mechanism_596780">https://www.alibabacloud.com/blog/an-in-depth-discussion-on-the-lsm-compaction-mechanism_596780</a></li><li><a href="https://zhuanlan.zhihu.com/p/380013595">https://zhuanlan.zhihu.com/p/380013595</a></li><li><a href="https://github.com/facebook/rocksdb/wiki/Iterator-Implementation">https://github.com/facebook/rocksdb/wiki/Iterator-Implementation</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;LSM-Tree&quot;&gt;&lt;a href=&quot;#LSM-Tree&quot; class=&quot;headerlink&quot; title=&quot;LSM Tree&quot;&gt;&lt;/a&gt;LSM Tree&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;LSM-Tree is a kind of storage eng</summary>
      
    
    
    
    
    <category term="LSM Storage" scheme="https://adooobe.github.io/tags/LSM-Storage/"/>
    
  </entry>
  
  <entry>
    <title>Bloom Filter Implementation and Optimization</title>
    <link href="https://adooobe.github.io/2023/10/02/bloom/"/>
    <id>https://adooobe.github.io/2023/10/02/bloom/</id>
    <published>2023-10-02T11:11:52.000Z</published>
    <updated>2023-11-15T03:07:01.011Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Bloom-Filter"><a href="#Bloom-Filter" class="headerlink" title="Bloom Filter"></a>Bloom Filter</h1><h2 id="What-is-Bloom-Filter"><a href="#What-is-Bloom-Filter" class="headerlink" title="What is Bloom Filter"></a>What is Bloom Filter</h2><p>A bloom filter is a probabilistic data structure that is based on hashing. It is extremely space efficient and is typically used to add elements to a set and test if an element is in a set. Though, the elements themselves are not added to a set. Instead a hash of the elements is added to the set.</p><h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BloomFilter</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, m, k</span>):</span><br><span class="line">        self.m = m</span><br><span class="line">        self.k = k</span><br><span class="line">        self.data = [<span class="number">0</span>]*m</span><br><span class="line">        self.n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert</span>(<span class="params">self, element</span>):</span><br><span class="line">        <span class="keyword">if</span> self.k == <span class="number">1</span>:</span><br><span class="line">            hash1 = h1(element) % self.m</span><br><span class="line">            self.data[hash1] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> self.k == <span class="number">2</span>:</span><br><span class="line">            hash1 = h1(element) % self.m</span><br><span class="line">            hash2 = h2(element) % self.m</span><br><span class="line">            self.data[hash1] = <span class="number">1</span></span><br><span class="line">            self.data[hash2] = <span class="number">1</span></span><br><span class="line">        self.n += <span class="number">1</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">self, element</span>):</span><br><span class="line">        <span class="keyword">if</span> self.k == <span class="number">1</span>:</span><br><span class="line">            hash1 = h1(element) % self.m</span><br><span class="line">            <span class="keyword">if</span> self.data[hash1] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"Not in Bloom Filter"</span></span><br><span class="line">        <span class="keyword">elif</span> self.k == <span class="number">2</span>:</span><br><span class="line">            hash1 = h1(element) % self.m</span><br><span class="line">            hash2 = h2(element) % self.m</span><br><span class="line">            <span class="keyword">if</span> self.data[hash1] == <span class="number">0</span> <span class="keyword">or</span> self.data[hash2] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"Not in Bloom Filter"</span></span><br><span class="line">        p = (<span class="number">1.0</span> - ((<span class="number">1.0</span> - <span class="number">1.0</span>/self.m) * (self.k*self.n))) * self.k</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Might be in Bloom Filter with false positive probability "</span>+<span class="built_in">str</span>(prob)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">h1</span>(<span class="params">w</span>):</span><br><span class="line">    h = hashlib.md5(w)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hash</span>(h.digest().encode(<span class="string">'base64'</span>)[:<span class="number">6</span>])%<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">h2</span>(<span class="params">w</span>):</span><br><span class="line">    h = hashlib.sha256(w)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hash</span>(h.digest().encode(<span class="string">'base64'</span>)[:<span class="number">6</span>])%<span class="number">10</span></span><br></pre></td></tr></table></figure><p>In this sample, we implement a simple Bloom Filter which has two hash function(controlled by <em>k</em>) to compute the position of input element in the bit array (named data, array size is <em>m</em>).</p><p>When an element inserts into BloomFilter, two positions will be changed to 1 in the bit array computed by hash function so that if the element comes again, BloomFilter will get and check if the two positions are both 1. So when other element comes, if any position is not 1, the element doesn’t exist in the data array.</p><p>It is worth noting that different elements can get same hash values computed by hash function. It means one grid in the bit array is not independently used by unique element but shared. In other words, it can be covered.</p><p>So, in practical applications, how do we determine the number of hash functions to choose? How much space should be allocated for the array? What is the expected number of elements to be stored? How do we control the error? You can refer to the calculation formulas to determine how to design a bloom filter.</p><p>n = ceil(m / (-k / log(1 - exp(log(p) / k))))</p><p>p = pow(1 - exp(-k / (m / n)), k)</p><p>m = ceil((n * log(p)) / log(1 / pow(2, log(2))));</p><p>k = round((m / n) * log(2));</p><h2 id="drawback"><a href="#drawback" class="headerlink" title="drawback"></a>drawback</h2><p>As mentioned above, Bloom Filter can creat false positives that Bloom Filter has a certain probability of mistakenly identifying non-existent elements.</p><p>We have two choices of parameters when building a bloom filter, <code>m</code> and <code>k</code>. They should each be chosen to dampen the number of false positives as much as possible while still maintaining whatever space requirement the filter needs.</p><p>If we have a bloom filter with <code>m</code> bits and <code>k</code> hash functions, the probability that a certain bit will still be zero after one insertion is</p><p><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="10.927ex" height="2.497ex" role="img" focusable="false" viewbox="0 -853.7 4829.8 1103.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1111.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(2111.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2611.4,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mi" transform="translate(3111.4,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="msup" transform="translate(3989.4,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mi" transform="translate(422,363) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></g></svg></mjx-container></p><p>Then, after <code>n</code> insertions, the probability of it still being zero after <code>n</code> insertions is</p><p><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="11.887ex" height="2.497ex" role="img" focusable="false" viewbox="0 -853.7 5254.1 1103.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1111.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(2111.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2611.4,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mi" transform="translate(3111.4,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="msup" transform="translate(3989.4,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="TeXAtom" transform="translate(422,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(600,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></g></g></svg></mjx-container></p><p>So, that means the probability of a false positive is</p><p><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="18.566ex" height="2.497ex" role="img" focusable="false" viewbox="0 -853.7 8206 1103.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1111.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mo" transform="translate(2111.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(2500.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(3222.7,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(4222.9,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(4722.9,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mi" transform="translate(5222.9,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="msup" transform="translate(6100.9,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="TeXAtom" transform="translate(422,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(600,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g><g data-mml-node="msup" transform="translate(7365.6,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mi" transform="translate(422,363) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></g></svg></mjx-container></p><p>In each of these equations, raising the value of k (the number of hash functions) will make the probability of a false positive less likely. However, it is not computationally efficient to have an enormous value for <em>k</em>. To minimize this equation, we must choose the best <em>k</em>. We do it this way because we assume that the programmer has already chosen an <strong>m</strong> based on their space constraints and that they have some idea what their potential <em>n</em> will be. So the <em>k</em> value that minimizes that equation is</p><p><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="15.229ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 6731 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><g data-mml-node="mo" transform="translate(798.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(1854.6,0)"><path data-c="1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"/></g><g data-mml-node="mi" transform="translate(2152.6,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2752.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(3141.6,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mo" transform="translate(3641.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(4252.8,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/></g><g data-mml-node="mi" transform="translate(4753,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(5631,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mi" transform="translate(6131,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></p><h3 id="Hudi-Upsert"><a href="#Hudi-Upsert" class="headerlink" title="Hudi Upsert"></a>Hudi Upsert</h3><h3 id="LSM-Tree"><a href="#LSM-Tree" class="headerlink" title="LSM-Tree"></a>LSM-Tree</h3><p>See <a href="https://adooobe.github.io/2023/10/02/lsm-tree/">LSM-Tree</a></p><h3 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h3><ol><li><a href="https://zhuanlan.zhihu.com/p/294069121">White List Question</a></li><li><a href="https://www.51cto.com/article/753025.html">Redis Cache Breakdown</a></li></ol><h2 id="Improvement"><a href="#Improvement" class="headerlink" title="Improvement"></a>Improvement</h2><p>There are two limitations that have always restricted the usage of Bloom Filter, bounded source and append-only. The following are several improvement methods that revolve around addressing these two issues.</p><h4 id="Scalable-Bloom-Filters-SBF"><a href="#Scalable-Bloom-Filters-SBF" class="headerlink" title="Scalable Bloom Filters (SBF)"></a>Scalable Bloom Filters (SBF)</h4><p><img src="/2023/10/02/bloom/scalable_bloom_filter.png#pic_center" alt="scalable bloom filter structure"></p><p>when the filter reaches some fulfillness threshold, it becomes read-only and new bigger and writable filter is created in its place. If in its turn it becomes saturated, the operation is repeated. Every new filter, in order to keep the false positives rate close to the targeted one, has more hash functions than the previous filter.</p><p>In Scalable Bloom filter the membership test is applied on all created (read-only + writable) filters. If the item is missing in all filters, it’s considered as not existing. In the other side, if one of the filters reports its existence, it means that the element may be in the dataset. An important point to notice here is that Scalable Bloom filter uses a variant of Bloom filters where the bit vector is divided in <em>k</em> slices where each stores <em>M/k</em> bits (<em>M</em> is the size of whole bit vector). Since the number of slices is equal to the number of hash functions, each hash function works on its own slice:</p><p><img src="/2023/10/02/bloom/scalable_bloom_filter_slices.png#pic_center" alt="scalable bloom filter slices"></p><p>Thanks to the slices each element is always described by <em>k</em> bits resulting on more robust filter without the elements more prone to the false positives than the others.</p><h4 id="Counting-Bloom-Filter-CBF"><a href="#Counting-Bloom-Filter-CBF" class="headerlink" title="Counting Bloom Filter (CBF)"></a>Counting Bloom Filter (CBF)</h4><p>For the second question, CBF provides ability to delete elements in Bloom Filters. But unfortunately, the premise is that we must ensure that the deleted element is present in the Bloom filter.</p><p><img src="/2023/10/02/bloom/counting_bloom_filter.png#pic_center" alt="counting bloom filter structure"></p><h4 id="Cuckoo-Filter"><a href="#Cuckoo-Filter" class="headerlink" title="Cuckoo Filter"></a>Cuckoo Filter</h4><p>As an “improved version” of the Bloom Filter, the Cuckoo Filter uses the minimum space cost to achieve a reduction in false positives and support for reverse deletion.</p><p><img src="/2023/10/02/bloom/cuckoo_filter.png#pic_center" alt="Cuckoo Filter"></p><p>It only uses two hash functions H1 and H2 (on two hash tables/buckets T1 and T2) for Cuckoo Filter to compute the postion of input elements. If an element E1 comes into Cuckoo Filter:</p><ol><li>Compute the position on hashtable(or bucket) T1 with H1 and insert if the position P1 empty</li><li>If the P1 has other element, compute the position P2 on hashtable T2 with H2 and try to insert again</li><li>If the P2 is still not empty, kick out the element of the position on T2 then insert E1 into P2</li></ol><p>There are serveral issue on this design:</p><ol><li>kick-out loop</li><li>how to solve the element kicked out</li><li>size of hashtable</li></ol><p>Luckily, the designer makes a brilliant idea to solve all three problems at once, <code>MaxLoop</code> and <code>Resize</code>.</p><p>Cuckoo Filter would record the number of loop and when it comes to the <code>MaxLoop</code>, hash table would be resized and rehash (I think it needs to be allocated addtional memory to save the set of the elements and it can do rehash)</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol><li><a href="https://www.waitingforcode.com/big-data-algorithms/scalable-bloom-filter/read">https://www.waitingforcode.com/big-data-algorithms/scalable-bloom-filter/read</a></li><li>Baquero, C., &amp; Almeida, J. (2007, January). Scalable bloom filters. In European Conference on Principles of Data Mining and Knowledge Discovery (pp. 244-256). Springer, Berlin, Heidelberg.</li><li><a href="https://www.xiemingzhao.com/posts/cuckooFilter.html">https://www.xiemingzhao.com/posts/cuckooFilter.html</a></li><li><a href="https://www.cs.cmu.edu/~dga/papers/cuckoo-conext2014.pdf">https://www.cs.cmu.edu/~dga/papers/cuckoo-conext2014.pdf</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Bloom-Filter&quot;&gt;&lt;a href=&quot;#Bloom-Filter&quot; class=&quot;headerlink&quot; title=&quot;Bloom Filter&quot;&gt;&lt;/a&gt;Bloom Filter&lt;/h1&gt;&lt;h2 id=&quot;What-is-Bloom-Filter&quot;&gt;&lt;a </summary>
      
    
    
    
    
    <category term="Bloom-Filter" scheme="https://adooobe.github.io/tags/Bloom-Filter/"/>
    
  </entry>
  
</feed>
