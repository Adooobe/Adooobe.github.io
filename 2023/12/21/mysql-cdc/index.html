<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> mysql-cdc · Finch's Blog</title><meta name="description" content="mysql-cdc - Finchxia"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://Adooobe.github.io/atom.xml" title="Finch's Blog"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Finch's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Adooobe" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://www.xiaohongshu.com/user/profile/578ae95d82ec396a701d61d7?channelType=web_engagement_notification_page&amp;channelTabId=mentions" target="_blank" class="nav-list-link">RED</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">mysql-cdc</h1><div class="post-info">Dec 21, 2023</div><div class="post-content"><h2 id="CDC-Process"><a href="#CDC-Process" class="headerlink" title="CDC Process"></a>CDC Process</h2><p>A common binlog stream reader contains the parts as follows. However, in many open source library or project, some important steps are boxed as internal processes. Frequently, user should only concern about the connection to the server and how to handle the BinlogEvents. I will use <a target="_blank" rel="noopener" href="https://github.com/rusuly/mysql_cdc">rust-mysql-cdc</a> to introduce the whole process of mysql cdc.</p>
<h3 id="Connect-to-MySQL-Server-amp-Authentication"><a href="#Connect-to-MySQL-Server-amp-Authentication" class="headerlink" title="Connect to MySQL Server &amp; Authentication"></a>Connect to MySQL Server &amp; Authentication</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">connect</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(PacketChannel, DatabaseProvider), Error&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">channel</span> = PacketChannel::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">self</span>.options)?;</span><br><span class="line">        <span class="keyword">let</span> (packet, seq_num) = channel.<span class="title function_ invoke__">read_packet</span>()?;</span><br><span class="line">        <span class="title function_ invoke__">check_error_packet</span>(&amp;packet, <span class="string">&quot;Initial handshake error.&quot;</span>)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handshake</span> = HandshakePacket::<span class="title function_ invoke__">parse</span>(&amp;packet)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">auth_plugin</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">get_auth_plugin</span>(&amp;handshake.auth_plugin_name)?;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">authenticate</span>(&amp;<span class="keyword">mut</span> channel, &amp;handshake, auth_plugin, seq_num + <span class="number">1</span>)?;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>((channel, DatabaseProvider::<span class="title function_ invoke__">from</span>(&amp;handshake.server_version)))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>User provides the connection info and get one PacketChannel(TCPStream).</li>
<li>Get authentication method and authenticate</li>
</ol>
<h3 id="Register-as-a-slave"><a href="#Register-as-a-slave" class="headerlink" title="Register as a slave"></a>Register as a slave</h3><p><a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/com_register_slave/">RegisterSlave</a></p>
<p>In Rust, we need to construct a message and send to the PacketChannel as above which includes</p>
<ul>
<li>COM_REGISTER_SLAVE command</li>
<li>server_id</li>
<li><strong>Empty</strong> host user password port rank masterid</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">RegisterSlaveCommand</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(server_id: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123; server_id &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">serialize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;, io::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cursor</span> = Cursor::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> vec);</span><br><span class="line"></span><br><span class="line">        cursor.<span class="title function_ invoke__">write_u8</span>(CommandType::RegisterSlave <span class="keyword">as</span> <span class="type">u8</span>)?;</span><br><span class="line">        cursor.write_u32::&lt;LittleEndian&gt;(<span class="keyword">self</span>.server_id)?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Empty host, user, password, port, rank, masterid</span></span><br><span class="line">        cursor.<span class="title function_ invoke__">write_u8</span>(<span class="number">0</span>)?;</span><br><span class="line">        cursor.<span class="title function_ invoke__">write_u8</span>(<span class="number">0</span>)?;</span><br><span class="line">        cursor.<span class="title function_ invoke__">write_u8</span>(<span class="number">0</span>)?;</span><br><span class="line">        cursor.write_u16::&lt;LittleEndian&gt;(<span class="number">0</span>)?;</span><br><span class="line">        cursor.write_u32::&lt;LittleEndian&gt;(<span class="number">0</span>)?;</span><br><span class="line">        cursor.write_u32::&lt;LittleEndian&gt;(<span class="number">0</span>)?;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(vec)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Binlog-Dump"><a href="#Binlog-Dump" class="headerlink" title="Binlog Dump"></a>Binlog Dump</h3><p>Same as RegisterSlave, DumpBinogCommand needs:</p>
<ul>
<li>server_id</li>
<li>binlog_filename</li>
<li>binlog_position</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">DumpBinlogCommand</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> server_id: <span class="type">u32</span>,</span><br><span class="line">    <span class="keyword">pub</span> binlog_filename: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> binlog_position: <span class="type">u32</span>,</span><br><span class="line">    <span class="keyword">pub</span> flags: <span class="type">u16</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">DumpBinlogCommand</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(server_id: <span class="type">u32</span>, binlog_filename: <span class="type">String</span>, binlog_position: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            server_id,</span><br><span class="line">            binlog_filename,</span><br><span class="line">            binlog_position,</span><br><span class="line">            flags: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">serialize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;, io::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vec</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cursor</span> = Cursor::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> vec);</span><br><span class="line"></span><br><span class="line">        cursor.<span class="title function_ invoke__">write_u8</span>(CommandType::BinlogDump <span class="keyword">as</span> <span class="type">u8</span>)?;</span><br><span class="line">        cursor.write_u32::&lt;LittleEndian&gt;(<span class="keyword">self</span>.binlog_position)?;</span><br><span class="line">        cursor.write_u16::&lt;LittleEndian&gt;(<span class="keyword">self</span>.flags)?;</span><br><span class="line">        cursor.write_u32::&lt;LittleEndian&gt;(<span class="keyword">self</span>.server_id)?;</span><br><span class="line">        cursor.<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.binlog_filename.<span class="title function_ invoke__">as_bytes</span>())?;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(vec)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Handle-Binlog-Events"><a href="#Handle-Binlog-Events" class="headerlink" title="Handle Binlog Events"></a>Handle Binlog Events</h3><p>As mentioned above, usually, we let users handle these events but firstly, we need to parse them.</p>
<h3 id="HeartBeats"><a href="#HeartBeats" class="headerlink" title="HeartBeats"></a>HeartBeats</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">set_master_heartbeat</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, channel: &amp;<span class="keyword">mut</span> PacketChannel) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">milliseconds</span> = <span class="keyword">self</span>.options.heartbeat_interval.<span class="title function_ invoke__">as_millis</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">nanoseconds</span> = milliseconds * <span class="number">1000</span> * <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">query</span> = <span class="built_in">format!</span>(<span class="string">&quot;set @master_heartbeat_period=&#123;&#125;&quot;</span>, nanoseconds);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">command</span> = QueryCommand::<span class="title function_ invoke__">new</span>(query.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">    channel.<span class="title function_ invoke__">write_packet</span>(&amp;command.<span class="title function_ invoke__">serialize</span>()?, <span class="number">0</span>)?;</span><br><span class="line">    <span class="keyword">let</span> (packet, _) = channel.<span class="title function_ invoke__">read_packet</span>()?;</span><br><span class="line">    <span class="title function_ invoke__">check_error_packet</span>(&amp;packet, <span class="string">&quot;Setting master heartbeat error.&quot;</span>)?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2010.12597.pdf">https://arxiv.org/pdf/2010.12597.pdf</a><br>2.</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2023/10/30/snowflake-stream/" class="next">NEXT</a></div><div class="copyright"><p>For yyh, foul-weather and lovely friend</p><p>© 2023 - 2024 <a href="https://Adooobe.github.io">Finchxia</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>