<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> sql-parser design · Finch's Blog</title><meta name="description" content="sql-parser design - Finch Xia"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://Adooobe.github.io/atom.xml" title="Finch's Blog"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Finch's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Adooobe" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">sql-parser design</h1><div class="post-info">Apr 9, 2024</div><div class="post-content"><h2 id="TDOP-Top-Down-Operator-Precedence-Algorithm"><a href="#TDOP-Top-Down-Operator-Precedence-Algorithm" class="headerlink" title="TDOP(Top Down Operator Precedence) Algorithm"></a>TDOP(Top Down Operator Precedence) Algorithm</h2><p>The Top-Down Operator Precedence (TDOP) algorithm primarily addresses the challenge of efficiently performing lexical and syntactic analysis in compilers, especially in handling operator precedence and associativity rules. By setting different precedence levels and utilizing a look-ahead mechanism, TDOP effectively manages issues related to operator left-associativity, right-associativity, and parentheses, thereby enabling a concise and flexible strategy for parsing expressions. This approach simplifies and streamlines the process of parsing various expression syntaxes, making it widely applicable in the design of compilers and interpreters.</p>
<blockquote>
<p>Top down operator precedence parsing (TDOP from now on) is based on a few fundamental principles:</p>
<ul>
<li>A “binding power” mechanism to handle precedence levels</li>
<li>A means of implementing different functionality of tokens depending on their position relative to their neighbors - prefix or infix.</li>
<li>As opposed to classic RD, where semantic actions are associated with grammar rules (BNF), TDOP associates them with tokens.</li>
</ul>
</blockquote>
<h3 id="Bind-Power"><a href="#Bind-Power" class="headerlink" title="Bind Power"></a>Bind Power</h3><p>In my opinion, bind power is used to define the operator precedence. There are two bind powers (lbp and rbp) for each token in TDOP Algorithm to determine the order precedence. Sepecilly, for the ternary operator like <code>a = b ? c : d</code>, it can be devided into two binary operator <code>?</code> and <code>:</code>.</p>
<p>For example, there is an expression including two different tokens and three expressions(although it is only one letter)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a + b * c</span><br><span class="line">^ ^ ^ ^ ^</span><br><span class="line">E A F B G</span><br></pre></td></tr></table></figure>
<p>We know that multiplication take precedence of addition operator, so we can set the bind power of multiplication = 20, addtion = 10 for the process of TDOP Algorithm to transfer the expressions to AST(Abstract Syntax Tree).</p>
<h3 id="Pseudocode"><a href="#Pseudocode" class="headerlink" title="Pseudocode"></a>Pseudocode</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">expression</span>(<span class="params">rbp=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">global</span> token</span><br><span class="line">    t = token</span><br><span class="line">    token = <span class="built_in">next</span>()</span><br><span class="line">    left = t.nud()</span><br><span class="line">    <span class="keyword">while</span> rbp &lt; token.lbp:</span><br><span class="line">        t = token</span><br><span class="line">        token = <span class="built_in">next</span>()</span><br><span class="line">        left = t.led(left)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> left</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">literal_token</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value</span>):</span><br><span class="line">        self.value = <span class="built_in">int</span>(value)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">nud</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.value</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">operator_add_token</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    lbp = <span class="number">10</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">led</span>(<span class="params">self, left</span>):</span><br><span class="line">        right = expression(<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">return</span> left + right</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">operator_mul_token</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    lbp = <span class="number">20</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">led</span>(<span class="params">self, left</span>):</span><br><span class="line">        <span class="keyword">return</span> left * expression(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">end_token</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    lbp = <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Besides, in our instance, a simple tokenizer for basic arithmetic operations is neccessary</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">token_pat = re.<span class="built_in">compile</span>(<span class="string">&quot;\s*(?:(\d+)|(.))&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tokenize</span>(<span class="params">program</span>):</span><br><span class="line">    <span class="keyword">for</span> number, operator <span class="keyword">in</span> token_pat.findall(program):</span><br><span class="line">        <span class="keyword">if</span> number:</span><br><span class="line">            <span class="keyword">yield</span> literal_token(number)</span><br><span class="line">        <span class="keyword">elif</span> operator == <span class="string">&quot;+&quot;</span>:</span><br><span class="line">            <span class="keyword">yield</span> operator_add_token()</span><br><span class="line">        <span class="keyword">elif</span> operator == <span class="string">&quot;*&quot;</span>:</span><br><span class="line">            <span class="keyword">yield</span> operator_mul_token()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> SyntaxError(<span class="string">&#x27;unknown operator: %s&#x27;</span>, operator)</span><br><span class="line">    <span class="keyword">yield</span> end_token()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">program</span>):</span><br><span class="line">    <span class="keyword">global</span> token, <span class="built_in">next</span></span><br><span class="line">    <span class="built_in">next</span> = tokenize(program).<span class="built_in">next</span></span><br><span class="line">    token = <span class="built_in">next</span>()</span><br><span class="line">    <span class="keyword">return</span> expression()</span><br></pre></td></tr></table></figure>
<p>We should notice that function <code>def tokenize(program)</code> using <code>yield</code>, which return a generator it can be seen as an iterator to use.</p>
<p>Let’s see an example:</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span> + <span class="number">1</span> * <span class="number">2</span> * <span class="number">4</span> + <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>process:</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;expression with rbp <span class="number">0</span>&gt;&gt; </span><br><span class="line">    &lt;&lt;literal nud = <span class="number">3</span>&gt;&gt;</span><br><span class="line">    &lt;&lt;led of <span class="string">&quot;+&quot;</span>&gt;&gt;</span><br><span class="line">    &lt;&lt;expression with rbp <span class="number">10</span>&gt;&gt; call <span class="string">&#x27;+&#x27;</span>.led(<span class="number">3</span>)</span><br><span class="line">       &lt;&lt;literal nud = <span class="number">1</span>&gt;&gt;</span><br><span class="line">       &lt;&lt;led of <span class="string">&quot;*&quot;</span>&gt;&gt;</span><br><span class="line">       &lt;&lt;expression with rbp <span class="number">20</span>&gt;&gt; call <span class="string">&#x27;*&#x27;</span>.led(<span class="number">1</span>)</span><br><span class="line">          &lt;&lt;literal nud = <span class="number">2</span>&gt;&gt; <span class="keyword">return</span> <span class="number">1</span> * <span class="number">2</span></span><br><span class="line">       &lt;&lt;led of <span class="string">&quot;*&quot;</span>&gt;&gt;</span><br><span class="line">       &lt;&lt;expression with rbp <span class="number">20</span>&gt;&gt; call <span class="string">&#x27;*&#x27;</span>.led(<span class="number">2</span>)</span><br><span class="line">          &lt;&lt;literal nud = <span class="number">4</span>&gt;&gt; <span class="keyword">return</span> <span class="number">2</span> * <span class="number">4</span></span><br><span class="line">    &lt;&lt;led of <span class="string">&quot;+&quot;</span>&gt;&gt;</span><br><span class="line">    &lt;&lt;expression with rbp <span class="number">10</span>&gt;&gt; call <span class="string">&#x27;+&#x27;</span>.led(<span class="number">8</span>)</span><br><span class="line">       &lt;&lt;literal nud = <span class="number">5</span>&gt;&gt; <span class="keyword">return</span> <span class="number">8</span> + <span class="number">5</span></span><br></pre></td></tr></table></figure>
<h4 id="Duality"><a href="#Duality" class="headerlink" title="Duality"></a>Duality</h4><p>Ok, let us think about subtraction operator. Generally, on both sides of a subtraction operation, there is an expression, but sometimes the subtraction can also be considered as a negation operation. In other words, for <code>&#39;-&#39;</code>, it could be both binary andunary operator.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">operator_sub_token</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    lbp = <span class="number">10</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">nud</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> -expression(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">led</span>(<span class="params">self, left</span>):</span><br><span class="line">        <span class="keyword">return</span> left - expression(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>Example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3 - 2 + 4 * -5</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;&lt;expression <span class="keyword">with</span> rbp <span class="number">0</span>&gt;&gt; </span><br><span class="line">    &lt;&lt;literal nud = <span class="number">3</span>&gt;&gt;</span><br><span class="line">    &lt;&lt;led of <span class="string">&quot;-&quot;</span>&gt;&gt;</span><br><span class="line">    &lt;&lt;expression <span class="keyword">with</span> rbp <span class="number">10</span>&gt;&gt; call <span class="string">&#x27;-&#x27;</span>.led(<span class="number">3</span>)</span><br><span class="line">       &lt;&lt;literal nud = <span class="number">2</span>&gt;&gt;</span><br><span class="line">       &lt;&lt;lbp = rbp = <span class="number">10</span>&gt;&gt; <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">    &lt;&lt;led of <span class="string">&quot;+&quot;</span>&gt;&gt; </span><br><span class="line">       &lt;&lt;expression <span class="keyword">with</span> rbp <span class="number">10</span>&gt;&gt; call <span class="string">&#x27;+&#x27;</span>.led(<span class="number">1</span>)</span><br><span class="line">          &lt;&lt;literal nud = <span class="number">4</span>&gt;&gt;</span><br><span class="line">          &lt;&lt;led of <span class="string">&quot;*&quot;</span>&gt;&gt; call <span class="string">&#x27;*&#x27;</span>.led(<span class="number">4</span>)</span><br><span class="line">            &lt;&lt;expression <span class="keyword">with</span> rbp <span class="number">20</span>&gt;&gt; call -expression(<span class="number">100</span>)</span><br><span class="line">              &lt;&lt;nud of <span class="string">&quot;-&quot;</span>&gt;&gt; </span><br><span class="line">                &lt;&lt;expression <span class="keyword">with</span> rbp <span class="number">100</span>&gt;&gt;</span><br><span class="line">                  &lt;&lt;literal nud = <span class="number">5</span>&gt;&gt; <span class="keyword">return</span> <span class="number">5</span></span><br><span class="line">                <span class="comment"># return -5</span></span><br><span class="line">            <span class="comment"># return 4 * -5</span></span><br><span class="line">       <span class="comment"># return left = 1 + -20</span></span><br><span class="line">    <span class="comment"># return -19</span></span><br></pre></td></tr></table></figure>
<h4 id="Right-Associative"><a href="#Right-Associative" class="headerlink" title="Right Associative"></a>Right Associative</h4><p>Like exponentiation, we can do that by calling <strong>expression</strong> <strong>in the handler of exponentiation with a</strong> <strong>rbp</strong> <strong>lower than the</strong> <strong>lbp</strong> of exponentiation:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class operator_pow_token(object):</span><br><span class="line">    lbp = 30</span><br><span class="line">    def led(self, left):</span><br><span class="line">        return left ** expression(30 - 1)</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><a target="_blank" rel="noopener" href="https://eli.thegreenplace.net/2010/01/02/top-down-operator-precedence-parsing">https://eli.thegreenplace.net/2010/01/02/top-down-operator-precedence-parsing</a><br>2.</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2024/04/10/data-lineage/" class="prev">PREV</a><a href="/2023/12/21/mysql-cdc/" class="next">NEXT</a></div><div class="copyright"><p>Being softer and more powerful</p><p>© 2023 - 2024 <a href="https://Adooobe.github.io">Finch Xia</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>